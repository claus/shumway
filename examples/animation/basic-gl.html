<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body style="background-color: #333333;">
  <script src="../../src/avm2/util.js"></script>
  <script src="../../src/swf/util.js"></script>
  <script src="../../src/flash/util.js"></script>
  <script src="../../src/swf/gl/canvas-gl.js"></script>
  <script src="../inspector/js/classes/FPS.js"></script>
  <script src="../inspector/js/classes/Terminal.js"></script>
  <style>
    #debugInfoContainer {
      position: absolute;
      top: 114px;
      bottom: 32px;
      right: 0;
      width: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      background-color: rgba(0, 0, 0, 0.2);

      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>
  <div>
    <canvas id="fpsCanvas" height="100" style="background-color: #333333;"></canvas>
  </div>
  <div>
    <canvas id="stageCanvas" width="768" height="768"></canvas>
  </div>
  <div id="debugInfoContainer">
    <canvas id="traceTerminal" width="600" height="800" tabindex='2'></canvas>
  </div>

  <script>
    var traceTerminal = new Terminal(document.getElementById("traceTerminal")); traceTerminal.refreshEvery(100);
    function appendToTraceTerminal(str, color) {
      var scroll = traceTerminal.isScrolledToBottom();
      traceTerminal.buffer.append(str, color);
      if (scroll) {
        traceTerminal.gotoLine(traceTerminal.buffer.length - 1);
        traceTerminal.scrollIntoView();
      }
    }
    var logToConsole = false;
    var console_log = console.log;
    var console_info = console.info;
    var console_warn = console.warn;
    console.log = function (str) {
      if (logToConsole) {
        console_log.apply(console, arguments);
      }
      appendToTraceTerminal([].join.call(arguments, " "));
    };
    console.info = function (str) {
      if (logToConsole) {
        console_info.apply(console, arguments);
      }
      appendToTraceTerminal([].join.call(arguments, " "), "#666600");
    };
    console.warn = function (str) {
      if (logToConsole) {
        console_warn.apply(console, arguments);
      }
      appendToTraceTerminal([].join.call(arguments, " "), "#FF6700");
    };

    var fps = new FPS(document.getElementById("fpsCanvas"));
    fps.setFrameRate(60);
    fps.refreshEvery(10);

    var canvas = document.getElementById("stageCanvas");
    var context = canvas.getContext("2d.gl");

//    window.addEventListener('resize', function () {
//      // resizeHandler();
//    }, false);

    // resizeHandler();

    function resizeHandler() {
      var parent = canvas.parentElement;
      this.cw = parent.offsetWidth;
      this.ch = parent.offsetHeight - 1;

      var devicePixelRatio = window.devicePixelRatio || 1;
      var backingStoreRatio = context.webkitBackingStorePixelRatio ||
          context.mozBackingStorePixelRatio ||
          context.msBackingStorePixelRatio ||
          context.oBackingStorePixelRatio ||
          context.backingStorePixelRatio || 1;

      if (devicePixelRatio !== backingStoreRatio) {
        var ratio = devicePixelRatio / backingStoreRatio;
        context.width = canvas.width = this.cw * ratio;
        context.height = canvas.height = this.ch * ratio;
        canvas.style.width = this.cw + 'px';
        canvas.style.height = this.ch + 'px';
        context.scale(ratio, ratio);
      } else {
        context.width = canvas.width = this.cw;
        context.height = canvas.height = this.ch;
      }

      var cssScale = 'scale(' + (0.25) + ', ' + (0.25) + ')';
      var style =
          '-moz-transform: ' + cssScale + ';' +
              '-webkit-transform: ' + cssScale + ';' +
              'transform: ' + cssScale + ';' +
              '-moz-transform-origin: 0% 0%;' +
              '-webkit-transform-origin: 0% 0%;' +
              'transform-origin: 0% 0%;';
      context._updateViewport();
      // canvas.setAttribute('style', style);

      // context.font = 11 + 'px Consolas, "Liberation Mono", Courier, monospace';
    }


    context.font = 14 + 'px Consolas, "Liberation Mono", Courier, monospace';

    var w = 32;
    var h = 32;

    var world;
    var root = new QuadTree(0, 0, canvas.width, canvas.height, 0);

    (function render() {
      fps.enter("FRAME");
      renderWorld();
      fps.leave("FRAME");
      requestAnimationFrame(render);
    })();

    function addActors(count) {
      for (var i = 0; i < count; i++) {
        world.push({
          x: Math.random() * (canvas.width - w),
          y: 30 + Math.random() * (canvas.height - h - 30),
          r: 0,
          dx: (0.5 - Math.random()) * 1,
          dy: (0.5 - Math.random()) * 1,
          dr: Math.random() * 0.1
        });
      }
    }

    canvas.onclick = function () {
      addActors(1000);
      console.info("Actors: " + world.length);
    }

    function initializeWorld() {
      if (!world) {
        world = [];
        addActors(10);
      }
    }

    function insertAll() {
      for (var i = 0; i < world.length; i++) {
        root.insert(world[i]);
      }
    }

    function deleteAll() {
      for (var i = 0; i < world.length; i++) {
        root.delete(world[i]);
      }
    }

    function renderWorld() {
      // console.info("HERE");
      // console.info("MEMORY: " + performance.memory.usedJSHeapSize);
      initializeWorld();
      // insertAll();
      // deleteAll();
      context.fillStyle = "black";
      context.fillRect(0, 0, canvas.width, canvas.height);
      context.fillStyle = "white";
      context.clear();
      world.forEach(function (actor) {
        context.save();
        if (actor.x + actor.dx + w > canvas.width || actor.x + actor.dx < 0) {
          actor.dx *= -1;
        }
        if (actor.y + actor.dy + h > canvas.height || actor.y + actor.dy < 30) {
          actor.dy *= -1;
        }
        actor.x += actor.dx;
        actor.y += actor.dy;
        actor.r += actor.dr;
        context.translate(actor.x, actor.y);
        context.rotate(actor.r);
        context.translate(-w / 2, -h / 2);
        context.fillRect(0, 0, w, h);

        context.beginPath();
        context.arc(75,75,50,0,Math.PI*2,true); // Outer circle
        context.moveTo(110,75);
        context.arc(75,75,35,0,Math.PI,false);  // Mouth (clockwise)
        context.moveTo(65,65);
        context.arc(60,65,5,0,Math.PI*2,true);  // Left eye
        context.moveTo(95,65);
        context.arc(90,65,5,0,Math.PI*2,true);  // Right eye
        context.stroke();

        context.restore();
      });

      context.flush();
      // context.fillText("Actors: " + world.length, 10, 20);
    }
  </script>
</body>
</html>